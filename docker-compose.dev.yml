# Docker Compose for Liberation Analytics - Local Development
# Use this for local development with environment isolation

services:
  liberation-analytics-dev:
    build: .
    container_name: liberation-analytics-dev
    restart: unless-stopped
    ports:
      - "8080:8080"  # Analytics API
    environment:
      - ENVIRONMENT=development
      - DUCKDB_PATH=/app/data/analytics.db
      - DATABASE_URL=postgres://postgres:dev_password_change_me@postgres-dev:5432/liberation_analytics_dev
      - GIN_MODE=debug
      - ALLOWED_ORIGINS=http://localhost:3333,http://127.0.0.1:3333,http://localhost:3000,http://127.0.0.1:3000,http://localhost:3001,http://127.0.0.1:3001
      - API_TOKEN_SECRET=dev_secret_not_for_production_use_only
      - RATE_LIMIT_ENABLED=false
      - LOG_LEVEL=debug
    volumes:
      - ./data/analytics:/app/data
      - ./:/app  # Mount source for development (optional - enables hot reload if implemented)
    depends_on:
      postgres-dev:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - analytics-dev

  postgres-dev:
    image: postgres:15-alpine
    container_name: liberation-postgres-dev
    restart: unless-stopped
    ports:
      - "5433:5432"  # Different port to avoid conflicts with production
    environment:
      - POSTGRES_DB=liberation_analytics_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=dev_password_change_me
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d liberation_analytics_dev"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - analytics-dev

  # Optional: Redis for development (not required but useful for caching)
  redis-dev:
    image: redis:7-alpine
    container_name: liberation-redis-dev
    restart: unless-stopped
    ports:
      - "6380:6379"  # Different port to avoid conflicts
    command: redis-server --appendonly yes --maxmemory 64mb --maxmemory-policy allkeys-lru
    volumes:
      - ./data/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - analytics-dev

networks:
  analytics-dev:
    driver: bridge
    name: analytics-dev-network

# Local development volumes - stored in project directory
# ./data/analytics - DuckDB files
# ./data/postgres - PostgreSQL data
# ./data/redis - Redis persistence